<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Booking | Moments</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="common.css" />
  <link rel="stylesheet" href="16. Bookings/booking.css" />
  <script src="headerscript.js" defer></script>
  <script src="layout.js" defer></script>
  <style>
    /* Booking modal fade/scale animation */
    #booking_modal { opacity: 0; transition: opacity .22s ease; }
    #booking_modal.modal-open { opacity: 1; }
    #booking_modal .modal-card { transform: scale(0.98); opacity: 0; transition: transform .22s ease, opacity .22s ease; }
    #booking_modal.modal-open .modal-card { transform: scale(1); opacity: 1; }
  </style>
</head>

<body>
  <!-- Header -->
  <div id="header"></div>
  <!-- Header End -->

  <!-- Content -->
  <main class="booking-wrapper">
    <div class="booking-card">
      <h1 class="tagline" style="color: var(--brand-primary);">Booking</h1>
      <div id="booking-root"></div>
    </div>
  </main>
  <!-- Content End -->

  <!-- Footer -->
  <div id="footer"></div>
  <!-- Footer End -->

  <!-- Booking Modal -->
  <div id="booking_modal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.4); z-index:60; align-items:center; justify-content:center; padding: 20px;">
    <div class="booking-card modal-card" style="max-width:560px; width:100%; padding:20px; text-align:center;">
      <div id="booking_modal_icon" style="margin-bottom:8px;"></div>
      <h2 id="booking_modal_title" class="tagline" style="color: var(--brand-primary); font-size: 22px; margin:0 0 6px 0;">Notification</h2>
      <div id="booking_modal_message" class="helper" style="font-size: 1rem; color:#374151;"></div>
      <div class="inline" style="justify-content:center; margin-top:12px; gap:8px;">
        <button id="booking_modal_close" type="button" class="btn">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Optional config
    const CONFIG = {
      token: (window.BOOKING_AUTH && window.BOOKING_AUTH.token) || undefined,
      apiKey: (window.BOOKING_AUTH && window.BOOKING_AUTH.apiKey) || undefined,
      withCredentials: (window.BOOKING_AUTH && window.BOOKING_AUTH.withCredentials) || false,
      useMocks: !!window.BOOKING_USE_MOCKS,
      apiBase: 'http://localhost:8001'
    };

    // Request helper
    function prefixApi(path) {
      if (path.startsWith('http')) return path;
      const rel = path.startsWith('/api') ? path : ('/api' + (path.startsWith('/') ? path : '/' + path));
      return (CONFIG.apiBase || '') + rel;
    }
    function readCookie(name) {
      const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return m ? decodeURIComponent(m.pop()) : undefined;
    }
    async function request(method, path, body) {
      const url = prefixApi(path);
      const headers = { 'Accept': 'application/json', 'Content-Type': 'application/json' };
      if (CONFIG.token) headers['Authorization'] = 'Bearer ' + CONFIG.token;
      if (CONFIG.apiKey) headers['X-API-KEY'] = CONFIG.apiKey;
      const xsrf = readCookie('XSRF-TOKEN');
      if (xsrf) headers['X-XSRF-TOKEN'] = xsrf;
      const init = { method, headers };
      if (CONFIG.withCredentials) init.credentials = 'include';
      if (body !== undefined) init.body = JSON.stringify(body);
      const res = await fetch(url, init);
      if (!res.ok) {
        let text = '';
        try { text = await res.text(); } catch {}
        throw new Error('API ' + method + ' ' + url + ' failed: ' + res.status + ' ' + text);
      }
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) return res.json();
      return undefined;
    }
    window.BookingRequest = { request };

    // Popup helpers
    (function(){
      var modal = document.getElementById('booking_modal');
      var iconEl = document.getElementById('booking_modal_icon');
      var titleEl = document.getElementById('booking_modal_title');
      var msgEl = document.getElementById('booking_modal_message');
      var closeBtn = document.getElementById('booking_modal_close');
      function emailCheckIcon(){
        return '<svg viewBox="0 0 24 24" width="56" height="56" aria-hidden="true" focusable="false" style="color:var(--brand-primary);">\
          <g fill="currentColor">\
            <path d="M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H7.5a.5.5 0 0 1 0-1H20a1 1 0 0 0 1-1V7.5l-8.9 5.56a2 2 0 0 1-2.2 0L1 7.5V18a1 1 0 0 0 1 1h3.5a.5.5 0 0 1 0 1H2a2 2 0 0 1-2-2V6l0-.02L2 6Zm.99 0L12 11.75 21.01 6H2.99Z"/>\
            <path d="M7.5 21a.5.5 0 0 1 0-1h.29a5.5 5.5 0 1 1 0 1H7.5Zm7.7-1.85 2.65-2.65-.7-.7-1.95 1.95-.95-.95-.7.7 1.65 1.65Z"/>\
          </g>\
        </svg>';
      }
      function errorIcon(){
        return '<svg viewBox="0 0 24 24" width="56" height="56" aria-hidden="true" focusable="false" style="color:#b00020;">\
          <path fill="currentColor" d="M1 21h22L12 2 1 21zm12-3h-2v2h2v-2zm0-8h-2v6h2v-6z"/>\
        </svg>';
      }
      function openPopup(type, title, message){
        if (!modal) return;
        iconEl.innerHTML = (type === 'success') ? emailCheckIcon() : errorIcon();
        titleEl.textContent = title || (type === 'success' ? 'Booking Request Sent' : 'Submission Failed');
        msgEl.textContent = message || '';
        modal.style.display = 'flex';
        // allow transition on next frame
        requestAnimationFrame(function(){ modal.classList.add('modal-open'); });
        try { document.body.dataset.prevOverflow = document.body.style.overflow || ''; document.body.style.overflow = 'hidden'; } catch(_){ }
      }
      function closePopup(){
        if (!modal) return;
        modal.classList.remove('modal-open');
        modal.addEventListener('transitionend', function handler(){
          modal.removeEventListener('transitionend', handler);
          modal.style.display = 'none';
          try { document.body.style.overflow = document.body.dataset.prevOverflow || ''; delete document.body.dataset.prevOverflow; } catch(_){ }
        }, { once: true });
      }
      if (closeBtn) closeBtn.addEventListener('click', closePopup);
      if (modal) modal.addEventListener('click', function(e){ if (e.target === modal) closePopup(); });
      window.BookingPopup = { openPopup, closePopup };
    })();

    // Utils
    const pad = (n) => String(n).padStart(2, '0');
    const toYmd = (d) => d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate());
    function ymdToUtcSeconds(ymd) {
      const parts = ymd.split('-').map(Number);
      return Math.floor(Date.UTC(parts[0], parts[1] - 1, parts[2], 0, 0, 0, 0) / 1000);
    }
    function slotLowerToUpper(s) {
      if (s === 'morning') return 'MORNING';
      if (s === 'afternoon') return 'AFTERNOON';
      return 'FULL_DAY';
    }
    function normalizeAvailability(resp) {
      const byDate = {};
      const arr = Array.isArray(resp && resp.data) ? resp.data : [];
      for (const item of arr) {
        const secs = Number(item && item.date);
        if (!Number.isFinite(secs)) continue;
        const ymd = toYmd(new Date(secs * 1000));
        const slots = Array.isArray(item && item.available_slots) ? item.available_slots.filter(function (s) { return s === 'MORNING' || s === 'AFTERNOON' || s === 'FULL_DAY'; }) : [];
        if (slots.length) byDate[ymd] = slots;
      }
      return { dates: Object.keys(byDate).sort(), byDate: byDate };
    }
    window.BookingUtils = { toYmd, ymdToUtcSeconds, slotLowerToUpper, normalizeAvailability };

    // Build UI
    document.addEventListener('DOMContentLoaded', function () {
      var root = document.getElementById('booking-root');
      if (!root) return;

      root.innerHTML = '\
      <form id="booking-form" novalidate>\
        <div class="form-grid">\
          <div class="form-row row-span-2">\
            <label>Service Type</label>\
            <div class="inline" id="service-toggle">\
              <button type="button" class="btn btn-toggle" data-service="photographer" aria-pressed="true">Photographer</button>\
              <button type="button" class="btn btn-toggle" data-service="videographer" aria-pressed="false">Videographer</button>\
            </div>\
          </div>\
          <div class="form-row">\
            <label for="employee">Employee</label>\
            <select id="employee" class="select">\
              <option value="" disabled selected>Select photographer</option>\
            </select>\
            <div class="helper" id="employee-helper" style="display:none;">Loading availability...</div>\
            <div class="error" id="employee-error" style="display:none;"></div>\
          </div>\
          <div class="form-row">\
            <label for="date">Date</label>\
            <div style="position:relative">\
              <input id="date" class="input" type="text" readonly placeholder="Select an employee first" />\
              <div id="calendar-pop" class="calendar-popover" style="display:none; position:absolute; z-index:20;"></div>\
            </div>\
            <div class="error" id="date-error" style="display:none;"></div>\
          </div>\
          <div class="form-row">\
            <label>Time Slot</label>\
            <div class="inline" id="time-slots"></div>\
            <div class="helper" id="time-helper"></div>\
            <div class="error" id="time-error" style="display:none;"></div>\
          </div>\
          <div class="divider row-span-2"></div>\
          <div class="form-row row-span-2">\
            <label for="customer_name">Full Name</label>\
            <input id="customer_name" class="input" type="text" placeholder="Your full name" />\
            <div class="error" id="name-error" style="display:none;"></div>\
          </div>\
          <div class="form-row">\
            <label for="customer_phone">Phone Number</label>\
            <input id="customer_phone" class="input" type="tel" placeholder="+61 412345678" />\
            <div class="error" id="phone-error" style="display:none;"></div>\
          </div>\
          <div class="form-row">\
            <label for="customer_email">Email</label>\
            <input id="customer_email" class="input" type="email" placeholder="you@example.com" />\
            <div class="error" id="email-error" style="display:none;"></div>\
          </div>\
          <div class="row-span-2 button-container">\
            <button type="submit" class="btn" id="submit-btn">Submit Booking Request</button>\
          </div>\
        </div>\
      </form>';

      // State
      var formData = { serviceType: 'photographer', employeeId: '', date: '', time: '', customerName: '', phone: '', email: '' };
      var employees = [];
      var availability = { dates: [], byDate: {} };
      var currentMonth = new Date();
      var loadingAvail = false, submitting = false;
      var abortCtrl = null;

      // Elements
      var toggleWrap = document.getElementById('service-toggle');
      var employeeSelect = document.getElementById('employee');
      var employeeHelper = document.getElementById('employee-helper');
      var employeeError = document.getElementById('employee-error');
      var dateInput = document.getElementById('date');
      var calendarPop = document.getElementById('calendar-pop');
      var dateError = document.getElementById('date-error');
      var timeSlots = document.getElementById('time-slots');
      var timeHelper = document.getElementById('time-helper');
      var timeError = document.getElementById('time-error');
      var nameInput = document.getElementById('customer_name');
      var phoneInput = document.getElementById('customer_phone');
      var emailInput = document.getElementById('customer_email');
      var nameError = document.getElementById('name-error');
      var phoneError = document.getElementById('phone-error');
      var emailError = document.getElementById('email-error');
      var submitBtn = document.getElementById('submit-btn');
      var formEl = document.getElementById('booking-form');

      // Utils UI
      function setBtnSelected(btn, sel) {
        btn.classList.toggle('selected', !!sel);
        btn.setAttribute('aria-pressed', sel ? 'true' : 'false');
      }

      function updateToggle() {
        var btns = toggleWrap.querySelectorAll('button[data-service]');
        btns.forEach(function (b) { setBtnSelected(b, b.getAttribute('data-service') === formData.serviceType); });
        updateEmployeePlaceholder();
      }

      function updateEmployeePlaceholder() {
        var opt0 = employeeSelect.querySelector('option[value=""]');
        if (opt0) {
          var text = 'Select ' + (formData.serviceType === 'photographer' ? 'photographer' : 'videographer');
          if (filteredEmployees().length === 0) text = 'No ' + (formData.serviceType === 'photographer' ? 'photographers' : 'videographers') + ' available';
          opt0.textContent = text;
        }
      }

      function filteredEmployees() {
        return employees.filter(function (e) { return !e.service_type || e.service_type === formData.serviceType; });
      }

      function populateEmployees() {
        var list = filteredEmployees();
        employeeSelect.innerHTML = '';
        var opt0 = document.createElement('option');
        opt0.value = '';
        opt0.disabled = true; opt0.selected = true;
        opt0.textContent = list.length ? ('Select ' + (formData.serviceType === 'photographer' ? 'photographer' : 'videographer')) : ('No ' + (formData.serviceType === 'photographer' ? 'photographers' : 'videographers') + ' available');
        employeeSelect.appendChild(opt0);
        list.forEach(function (e) {
          var opt = document.createElement('option');
          opt.value = String(e.id);
          opt.textContent = e.name;
          employeeSelect.appendChild(opt);
        });
      }

      function setLoadingAvail(v) {
        loadingAvail = v;
        employeeHelper.style.display = (v && formData.employeeId) ? '' : 'none';
      }

      function clearErrors(keys) {
        if (!keys || keys.includes('employeeId')) { employeeError.style.display = 'none'; }
        if (!keys || keys.includes('date')) { dateError.style.display = 'none'; }
        if (!keys || keys.includes('time')) { timeError.style.display = 'none'; }
        if (!keys || keys.includes('customerName')) { nameError.style.display = 'none'; }
        if (!keys || keys.includes('phone')) { phoneError.style.display = 'none'; }
        if (!keys || keys.includes('email')) { emailError.style.display = 'none'; }
      }

      function showError(key, msg) {
        var map = { employeeId: employeeError, date: dateError, time: timeError, customerName: nameError, phone: phoneError, email: emailError };
        var el = map[key];
        if (el) { el.textContent = msg; el.style.display = msg ? '' : 'none'; }
      }

      function renderCalendar() {
        var year = currentMonth.getFullYear();
        var month = currentMonth.getMonth();
        var first = new Date(year, month, 1);
        var startDay = first.getDay();
        var daysInMonth = new Date(year, month + 1, 0).getDate();
        var html = '';
        html += '<div class="inline" style="justify-content:space-between;align-items:center;margin-bottom:8px">' +
          '<button type="button" class="btn" data-cal="prev" aria-label="Previous month">&lt;</button>' +
          '<div style="font-weight:700">' + currentMonth.toLocaleString('en-US', { month: 'long', year: 'numeric' }) + '</div>' +
          '<button type="button" class="btn" data-cal="next" aria-label="Next month">&gt;</button>' +
          '</div>';
        html += '<div class="inline" style="justify-content:space-between;font-weight:600">' + ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(function(d){return '<div style="width:36px;text-align:center">'+d+'</div>'}).join('') + '</div>';
        html += '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:6px">';
        for (var i=0;i<startDay;i++) html += '<div></div>';
        var availableSet = new Set(availability.dates);
        for (var d=1; d<=daysInMonth; d++) {
          var dateObj = new Date(year, month, d);
          var ymd = toYmd(dateObj);
          var enabled = availableSet.has(ymd);
          html += '<button type="button" class="cal-day" data-day="'+ymd+'" '+(enabled?'':'disabled')+' style="padding:6px 0;border:1px solid #eee;border-radius:6px;background:'+(enabled?'#fff':'#f2f2f2')+'">'+d+'</button>';
        }
        html += '</div>';
        calendarPop.innerHTML = html;
        var prev = calendarPop.querySelector('[data-cal="prev"]');
        var next = calendarPop.querySelector('[data-cal="next"]');
        prev.addEventListener('click', function(){ currentMonth = new Date(year, month-1, 1); renderCalendar(); });
        next.addEventListener('click', function(){ currentMonth = new Date(year, month+1, 1); renderCalendar(); });
        calendarPop.querySelectorAll('.cal-day').forEach(function(btn){
          btn.addEventListener('click', function(){ onSelectDate(btn.getAttribute('data-day')); });
        });
      }

      function onSelectDate(ymd) {
        formData.date = ymd;
        dateInput.value = ymd;
        closeCalendar();
        renderTimeSlots();
        clearErrors(['date','time']);
        dateInput.focus();
      }

      function openCalendar() {
        if (!formData.employeeId) return;
        renderCalendar();
        calendarPop.style.display = '';
        document.addEventListener('mousedown', onOutside);
        document.addEventListener('keydown', onEsc);
      }
      function closeCalendar() {
        calendarPop.style.display = 'none';
        document.removeEventListener('mousedown', onOutside);
        document.removeEventListener('keydown', onEsc);
      }
      function onOutside(e) {
        if (!calendarPop.contains(e.target)) closeCalendar();
      }
      function onEsc(e) { if (e.key === 'Escape') closeCalendar(); }

      function renderTimeSlots() {
        timeSlots.innerHTML = '';
        var slots = formData.date ? (availability.byDate[formData.date] || []) : [];
        if (!formData.date && availability.dates.length) {
          timeHelper.textContent = 'Select a date first';
        } else if (formData.date && slots.length === 0) {
          timeHelper.textContent = 'No time slots available for this selection';
        } else {
          timeHelper.textContent = '';
        }
        ['MORNING','AFTERNOON','FULL_DAY'].forEach(function (s) {
          if (slots.indexOf(s) === -1) return;
          var lower = (s === 'MORNING') ? 'morning' : (s === 'AFTERNOON' ? 'afternoon' : 'fullday');
          var label = (s === 'MORNING') ? 'Morning' : (s === 'AFTERNOON' ? 'Afternoon' : 'Full Day');
          var id = 'slot_' + lower;
          var wrap = document.createElement('label'); wrap.className = 'muted';
          var input = document.createElement('input'); input.type = 'radio'; input.name = 'slot'; input.value = lower; input.id = id;
          if (formData.time === lower) input.checked = true;
          input.addEventListener('change', function(){ formData.time = lower; clearErrors(['time']); });
          wrap.appendChild(input);
          wrap.appendChild(document.createTextNode(' ' + label));
          timeSlots.appendChild(wrap);
        });
      }

      function loadEmployees() {
        request('GET', '/employees?page=1').then(function (resp) {
          var data = Array.isArray(resp && resp.data) ? resp.data : [];
          var mapPos = function (pos) {
            var p = (pos || '').toUpperCase();
            if (p.indexOf('PHOTOGRAPHER') !== -1) return 'photographer';
            if (p.indexOf('VIDEOGRAPHER') !== -1) return 'videographer';
            return undefined;
          };
          employees = data.map(function (e) { return { id: e.id, name: e.name, service_type: mapPos(e.position) }; });
          populateEmployees(); updateToggle();
        }).catch(function (e) {
          console.error('Load employees failed', e);
          if (CONFIG.useMocks) {
            var mock = { data: [
              { id: 1, name: 'Alice', position: 'PHOTOGRAPHER', email: 'alice@example.com', phone: '08123' },
              { id: 2, name: 'Bob', position: 'VIDEOGRAPHER', email: 'bob@example.com', phone: '08124' },
            ] };
            var mapPos = function (pos) {
              var p = (pos || '').toUpperCase();
              if (p.indexOf('PHOTOGRAPHER') !== -1) return 'photographer';
              if (p.indexOf('VIDEOGRAPHER') !== -1) return 'videographer';
              return undefined;
            };
            employees = mock.data.map(function (e) { return { id: e.id, name: e.name, service_type: mapPos(e.position) }; });
            populateEmployees(); updateToggle();
          } else {
            employees = []; populateEmployees(); updateToggle();
          }
        });
      }

      function loadAvailability() {
        if (!formData.employeeId) { availability = { dates: [], byDate: {} }; renderTimeSlots(); return; }
        if (abortCtrl) abortCtrl.abort();
        abortCtrl = new AbortController();
        setLoadingAvail(true);
        request('GET', '/books/availability?employee_id=' + formData.employeeId).then(function (resp) {
          availability = normalizeAvailability(resp);
          if (availability.dates.length) {
            var ym = availability.dates[0].split('-'); currentMonth = new Date(Number(ym[0]), Number(ym[1]) - 1, 1);
          }
          if (formData.date && availability.dates.indexOf(formData.date) === -1) { formData.date = ''; dateInput.value = ''; }
          formData.time = '';
          renderTimeSlots();
        }).catch(function (e) {
          console.error('Availability failed', e);
          if (CONFIG.useMocks) {
            var mock = { data: [
              { date: 1758153600, available_slots: ['MORNING','AFTERNOON','FULL_DAY'] },
              { date: 1758240000, available_slots: ['MORNING'] },
            ] };
            availability = normalizeAvailability(mock);
            if (availability.dates.length) {
              var ym = availability.dates[0].split('-'); currentMonth = new Date(Number(ym[0]), Number(ym[1]) - 1, 1);
            }
          } else {
            availability = { dates: [], byDate: {} };
            formData.date = ''; dateInput.value = ''; formData.time = '';
          }
          renderTimeSlots();
        }).finally(function () { setLoadingAvail(false); });
      }

      // Handlers
      toggleWrap.addEventListener('click', function (e) {
        var btn = e.target.closest('button[data-service]');
        if (!btn) return;
        var st = btn.getAttribute('data-service');
        if (st && (st === 'photographer' || st === 'videographer')) {
          formData.serviceType = st;
          formData.employeeId = ''; employeeSelect.value = '';
          formData.date = ''; dateInput.value = '';
          formData.time = '';
          availability = { dates: [], byDate: {} };
          populateEmployees(); updateToggle(); renderTimeSlots();
          clearErrors();
        }
      });

      employeeSelect.addEventListener('change', function(){
        formData.employeeId = employeeSelect.value || '';
        clearErrors(['employeeId']);
        loadAvailability();
      });

      dateInput.addEventListener('click', function(){
        if (!formData.employeeId) return; // require employee first
        if (calendarPop.style.display === 'none' || !calendarPop.style.display) openCalendar(); else closeCalendar();
      });

      phoneInput.addEventListener('input', function(e){
        var v = phoneInput.value.replace(/[^0-9]/g, '');
        phoneInput.value = v; formData.phone = v; clearErrors(['phone']);
      });
      nameInput.addEventListener('input', function(){ formData.customerName = nameInput.value; clearErrors(['customerName']); });
      emailInput.addEventListener('input', function(){ formData.email = emailInput.value; clearErrors(['email']); });

      formEl.addEventListener('submit', function(e){
        e.preventDefault();
        // Validate
        var valid = true;
        clearErrors();
        if (!formData.employeeId) { showError('employeeId', 'Select a ' + (formData.serviceType === 'photographer' ? 'photographer' : 'videographer')); valid = false; }
        if (!formData.date) { showError('date', 'Select a booking date'); valid = false; }
        if (!formData.time) { showError('time', 'Select a booking time'); valid = false; }
        if (!formData.customerName.trim()) { showError('customerName', 'Name is required'); valid = false; }
        if (!formData.phone.trim()) { showError('phone', 'Phone number is required'); valid = false; }
        if (!formData.email.trim()) { showError('email', 'Email is required'); valid = false; }
        else if (!/\S+@\S+\.\S+/.test(formData.email)) { showError('email', 'Invalid email format'); valid = false; }
        if (!valid) return;
        // Submit
        submitting = true; submitBtn.disabled = true; submitBtn.textContent = 'Submitting...';
        var payload = {
          employee_id: Number(formData.employeeId),
          date: ymdToUtcSeconds(formData.date),
          time_slot: slotLowerToUpper(formData.time),
          status: 'PENDING',
          customer_name: formData.customerName.trim(),
          customer_email: formData.email.trim(),
          customer_phone: formData.phone.trim(),
        };
        request('POST', '/books', payload).then(function(){
          var emailCopy = formData.email.trim();
          BookingPopup.openPopup('success', 'Booking Request Sent', 'We\'ve sent a confirmation to ' + emailCopy + '. Please check your inbox (and spam) to confirm your booking.');
          // reset
          formData = { serviceType: formData.serviceType, employeeId: '', date: '', time: '', customerName: '', phone: '', email: '' };
          employeeSelect.value = ''; dateInput.value=''; nameInput.value=''; phoneInput.value=''; emailInput.value='';
          availability = { dates: [], byDate: {} }; renderTimeSlots();
        }).catch(function(err){
          console.error(err);
          BookingPopup.openPopup('error', 'Submission Failed', 'Failed to submit booking: ' + String(err));
        }).finally(function(){ submitting = false; submitBtn.disabled = false; submitBtn.textContent = 'Submit Booking Request'; });
      });

      // Init
      updateToggle();
      loadEmployees();
      renderTimeSlots();
    });
  </script>
</body>

</html>
