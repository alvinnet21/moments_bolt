<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin | Booking Requests</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="common.css" />
  <link rel="stylesheet" href="16. Bookings/booking.css" />
  <style>
    /* Modal fade/scale animation */
    #block_modal { opacity: 0; transition: opacity .22s ease; }
    #block_modal.modal-open { opacity: 1; }
    #block_modal .modal-card { transform: scale(0.98); opacity: 0; transition: transform .22s ease, opacity .22s ease; }
    #block_modal.modal-open .modal-card { transform: scale(1); opacity: 1; }
  </style>
  <script>
    // Simple guard: redirect to login when not authenticated
    try {
      var authed = (sessionStorage.getItem('adminAuthed') === 'true') || (localStorage.getItem('adminAuthed') === 'true');
      if (!authed) { window.location.replace('18. admin-login.html'); }
    } catch(e){ window.location.replace('18. admin-login.html'); }
  </script>
  <script src="headerscript.js" defer></script>
  <script src="layout.js" defer></script>
</head>

<body>
  <!-- Header -->
  <div id="header"></div>
  <!-- Header End -->

  <!-- Content -->
  <main class="booking-wrapper centered-main">
    <div class="booking-card">
      <div style="display:flex; justify-content:flex-end; margin-bottom:4px;">
        <button id="logout_btn" class="btn btn-ghost">Logout</button>
      </div>
      <header style="text-align:center; margin-bottom: 8px;">
        <h1 class="tagline" style="color: var(--brand-primary); margin-bottom: 4px;">Admin Dashboard</h1>
        <div class="helper">Manage your bookings and staff</div>
      </header>

      

      <div id="toast" style="position:fixed; top:16px; right:16px; z-index:50;"></div>

      <section id="filters" style="margin-top:12px;">
        <div class="form-grid">
          <div class="form-row">
            <label for="start_date">From Date</label>
            <div style="position:relative">
              <input id="start_date" class="input" type="text" readonly />
              <div id="cal_start" class="calendar-popover" style="display:none; position:absolute; z-index:20;"></div>
            </div>
          </div>
          <div class="form-row">
            <label for="end_date">To Date</label>
            <div style="position:relative; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
              <input id="end_date" class="input" type="text" readonly />
              <button class="btn btn-ghost btn-icon" id="load_btn" type="button" title="Reload list">
                <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 6V3L8 7l4 4V8c2.76 0 5 2.24 5 5 0 1.07-.34 2.06-.92 2.87l1.46 1.46A6.96 6.96 0 0 0 19 13c0-3.87-3.13-7-7-7zm-5.54.13A6.96 6.96 0 0 0 5 11c0 3.87 3.13 7 7 7v3l4-4-4-4v3c-2.76 0-5-2.24-5-5 0-1.07.34-2.06.92-2.87L6.46 6.13z"/></svg>
                <span>Load</span>
              </button>
              <button class="btn btn-icon" id="open_block_modal" type="button" title="Block availability">Block Availability</button>
              <span class="helper" id="loading_list" style="display:none;">Loading...</span>
              <div id="cal_end" class="calendar-popover" style="display:none; position:absolute; z-index:20;"></div>
            </div>
          </div>
        </div>
      </section>

      <section id="list" style="margin-top:16px;">
        <div id="empty_state" class="helper" style="display:none; text-align:center; margin:24px 0;"></div>
        <div id="cards" class="cards"></div>
        <div id="pagination" class="button-container" style="margin-top:16px;"></div>
      </section>
      
      <!-- Block Availability Modal -->
      <div id="block_modal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.4); z-index:60; align-items:center; justify-content:center; padding: 20px;">
        <div class="booking-card modal-card" style="max-width:1024px; width:90vw; padding:20px; max-height:85vh; overflow:visible;">
          <header style="margin-bottom:8px; text-align:center;">
            <h2 class="tagline" style="color: var(--brand-primary); font-size: 22px; margin:0;">Block Availability</h2>
            <div class="helper">Choose employee, date, and time to block</div>
          </header>
          <div class="form-grid">
            <div class="form-row">
              <label for="block_employee">Employee</label>
              <select id="block_employee" class="select">
                <option value="" disabled selected>Select employee</option>
              </select>
              <div class="helper" id="block_helper" style="display:none;">Loading availability...</div>
            </div>
            <div class="form-row" id="block_date_row" style="display:none;">
              <label for="block_date">Date</label>
              <div style="position:relative">
                <input id="block_date" class="input" type="text" readonly placeholder="Pick a date" />
                <div id="cal_block" class="calendar-popover" style="display:none; position:absolute; z-index:20;"></div>
              </div>
            </div>
            <div class="form-row" id="block_time_row" style="display:none;">
              <label>Time</label>
              <div id="block_times" class="inline"></div>
            </div>
          </div>
          <div class="inline" style="justify-content:flex-end; margin-top:12px; gap:8px;">
            <button id="block_close_btn" type="button" class="btn btn-ghost">Close</button>
            <button id="block_btn" type="button" class="btn">Block</button>
          </div>
        </div>
      </div>
    </div>
  </main>
  <!-- Content End -->

  <!-- Footer -->
  <div id="footer"></div>
  <!-- Footer End -->

  <script>
    // Logout wiring
    (function(){
      var btn = document.getElementById('logout_btn');
      if (btn) btn.addEventListener('click', function(){
        try { sessionStorage.removeItem('adminAuthed'); localStorage.removeItem('adminAuthed'); } catch(_) {}
        window.location.replace('18. admin-login.html');
      });
    })();

    // Config
    const CFG = { apiBase: 'http://localhost:8001' };
    // Utils
    const pad = (n) => String(n).padStart(2,'0');
    const toYmd = (d) => d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate());
    const parseYmd = (ymd) => { const [y,m,da] = ymd.split('-').map(Number); return new Date(y, m-1, da); };
    const compareYmd = (a,b) => a < b ? -1 : (a > b ? 1 : 0);
    const ymdToUtcSeconds = (ymd) => { const [y,m,d] = ymd.split('-').map(Number); return Math.floor(Date.UTC(y, m-1, d, 0,0,0,0)/1000); };
    const readCookie = (name) => { const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'); return m ? decodeURIComponent(m.pop()) : undefined; };
    function prefixApi(path){ if (path.startsWith('http')) return path; const rel = path.startsWith('/api')?path:('/api'+(path.startsWith('/')?path:'/'+path)); return CFG.apiBase + rel; }
    async function request(method, path, body){
      const url = prefixApi(path);
      const headers = { 'Accept':'application/json','Content-Type':'application/json' };
      const xsrf = readCookie('XSRF-TOKEN'); if (xsrf) headers['X-XSRF-TOKEN'] = xsrf;
      const init = { method, headers };
      if (body !== undefined) init.body = JSON.stringify(body);
      const res = await fetch(url, init);
      if (!res.ok) { let t=''; try{t=await res.text()}catch{} throw new Error('API '+method+' '+url+' failed: '+res.status+' '+t); }
      const ct = res.headers.get('content-type')||''; if (ct.includes('application/json')) return res.json(); return undefined;
    }
    function notify(msg, type){
      const root = document.getElementById('toast'); if (!root) return;
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.background = type==='error' ? '#b00020' : 'var(--brand-primary)';
      el.style.color = '#fff'; el.style.padding = '10px 12px'; el.style.borderRadius='8px'; el.style.marginTop='8px'; el.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';
      root.appendChild(el); setTimeout(()=>{ el.remove(); }, 3000);
    }

    // State
    let bookings = []; // normalized UI items
    let employeesMap = {}; // id -> name
    let dateFilter = (function(){
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), 1);
      const end = new Date(now.getFullYear(), now.getMonth()+1, 0);
      return { startDate: toYmd(start), endDate: toYmd(end) };
    })();
    let showStartCal = false, showEndCal = false;
    let currentMonthStart = new Date();
    let currentMonthEnd = new Date();
    let currentPage = 1, perPage = 5;
    let processing = {}; // id -> boolean
    let loadingList = false;

    // Elements
    const startInput = document.getElementById('start_date');
    const endInput = document.getElementById('end_date');
    const calStart = document.getElementById('cal_start');
    const calEnd = document.getElementById('cal_end');
    const loadBtn = document.getElementById('load_btn');
    const loadingEl = document.getElementById('loading_list');
    const cardsEl = document.getElementById('cards');
    const emptyState = document.getElementById('empty_state');
    const pagination = document.getElementById('pagination');

    // Block UI elements and state
    const blockEmpSelect = document.getElementById('block_employee');
    const blockDateInput = document.getElementById('block_date');
    const calBlock = document.getElementById('cal_block');
    const blockTimes = document.getElementById('block_times');
    const blockBtn = document.getElementById('block_btn');
    const blockModal = document.getElementById('block_modal');
    const openBlockBtn = document.getElementById('open_block_modal');
    const blockCloseBtn = document.getElementById('block_close_btn');
    let blockMonth = new Date();
    let blockForm = { employeeId: '', date: '', time: 'morning' };
    let blockAvailability = { dates: [], byDate: {} };
    let blockLoading = false;

    function renderFilters(){
      startInput.value = dateFilter.startDate;
      endInput.value = dateFilter.endDate;
    }

    function openCal(which){
      if (which==='start') { showStartCal=true; calStart.style.display=''; renderCalendar(calStart, currentMonthStart, function(ymd){ dateFilter.startDate = ymd; if (compareYmd(dateFilter.startDate, dateFilter.endDate)===1) dateFilter.endDate = ymd; closeCals(); renderFilters(); currentPage=1; renderTable(); }, 'start'); }
      else { showEndCal=true; calEnd.style.display=''; renderCalendar(calEnd, currentMonthEnd, function(ymd){ dateFilter.endDate = ymd; if (compareYmd(dateFilter.startDate, dateFilter.endDate)===1) dateFilter.startDate = ymd; closeCals(); renderFilters(); currentPage=1; renderTable(); }, 'end'); }
      document.addEventListener('mousedown', onOutside);
      document.addEventListener('keydown', onEsc);
    }
    function closeCals(){ showStartCal=false; showEndCal=false; calStart.style.display='none'; calEnd.style.display='none'; document.removeEventListener('mousedown', onOutside); document.removeEventListener('keydown', onEsc); }
    function onOutside(e){ if (!calStart.contains(e.target) && !calEnd.contains(e.target) && e.target!==startInput && e.target!==endInput) closeCals(); }
    function onEsc(e){ if (e.key==='Escape') closeCals(); }

    // Block date calendar open/close
    function openBlockCal(){
      calBlock.style.display='';
      renderBlockCalendar();
      document.addEventListener('mousedown', onBlockOutside);
      document.addEventListener('keydown', onBlockEsc);
    }
    function closeBlockCal(){ calBlock.style.display='none'; document.removeEventListener('mousedown', onBlockOutside); document.removeEventListener('keydown', onBlockEsc); }
    function onBlockOutside(e){ if (!calBlock.contains(e.target) && e.target!==blockDateInput) closeBlockCal(); }
    function onBlockEsc(e){ if (e.key==='Escape') closeBlockCal(); }
    function setBlockLoading(v){ blockLoading = v; const h = document.getElementById('block_helper'); if (h) h.style.display = v ? '' : 'none'; }

    function normalizeAvailability(resp){
      const byDate = {};
      const arr = Array.isArray(resp && resp.data) ? resp.data : [];
      for (const item of arr){
        const secs = Number(item && item.date);
        if (!Number.isFinite(secs)) continue;
        const ymd = toYmd(new Date(secs * 1000));
        const slots = Array.isArray(item && item.available_slots) ? item.available_slots.filter(function (s) { return s === 'MORNING' || s === 'AFTERNOON' || s === 'FULL_DAY'; }) : [];
        if (slots.length) byDate[ymd] = slots;
      }
      return { dates: Object.keys(byDate).sort(), byDate };
    }

    function renderBlockCalendar(){
      const year = blockMonth.getFullYear();
      const month = blockMonth.getMonth();
      const first = new Date(year, month, 1);
      const startDay = first.getDay();
      const dim = new Date(year, month+1, 0).getDate();
      let html='';
      html += '<div class="inline" style="justify-content:space-between;align-items:center;margin-bottom:8px">'+
        '<button type="button" class="btn" data-cal="prev">&lt;</button>'+
        '<div style="font-weight:700">'+ blockMonth.toLocaleString('en-US',{month:'long',year:'numeric'}) +'</div>'+
        '<button type="button" class="btn" data-cal="next">&gt;</button>'+
      '</div>';
      html += '<div class="inline" style="justify-content:space-between;font-weight:600">'+ ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=>'<div style="width:36px;text-align:center">'+d+'</div>').join('') +'</div>';
      html += '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:6px">';
      for (let i=0;i<startDay;i++) html += '<div></div>';
      const availableSet = new Set(blockAvailability.dates);
      for (let d=1; d<=dim; d++){
        const ymd = toYmd(new Date(year, month, d));
        const enabled = availableSet.has(ymd);
        html += '<button type="button" class="cal-day" data-day="'+ymd+'" '+(enabled?'':'disabled')+' style="padding:6px 0;border:1px solid #eee;border-radius:6px;background:'+(enabled?'#fff':'#f2f2f2')+'">'+d+'</button>';
      }
      html += '</div>';
      calBlock.innerHTML = html;
      const prev = calBlock.querySelector('[data-cal="prev"]');
      const next = calBlock.querySelector('[data-cal="next"]');
      prev.addEventListener('click', ()=>{ blockMonth = new Date(year, month-1, 1); renderBlockCalendar(); });
      next.addEventListener('click', ()=>{ blockMonth = new Date(year, month+1, 1); renderBlockCalendar(); });
      calBlock.querySelectorAll('.cal-day').forEach(btn=> btn.addEventListener('click', ()=> onSelectBlockDate(btn.getAttribute('data-day'))));
    }

    function onSelectBlockDate(ymd){
      blockForm.date = ymd; blockDateInput.value = ymd; closeBlockCal(); renderBlockTimeSlots();
    }

    function renderBlockTimeSlots(){
      if (!blockTimes) return;
      blockTimes.innerHTML = '';
      const slots = blockForm.date ? (blockAvailability.byDate[blockForm.date] || []) : [];
      if (!blockForm.date){ blockTimes.textContent = 'Select a date first'; return; }
      if (slots.length === 0){ blockTimes.textContent = 'No time slots available for this selection'; return; }
      ['MORNING','AFTERNOON','FULL_DAY'].forEach(function (s) {
        if (slots.indexOf(s) === -1) return;
        const lower = (s === 'MORNING') ? 'morning' : (s === 'AFTERNOON' ? 'afternoon' : 'fullday');
        const label = (s === 'MORNING') ? 'Morning' : (s === 'AFTERNOON' ? 'Afternoon' : 'Full Day');
        const id = 'block_slot_' + lower;
        const wrap = document.createElement('label'); wrap.className = 'muted';
        const input = document.createElement('input'); input.type = 'radio'; input.name = 'block_slot'; input.value = lower; input.id = id;
        if (blockForm.time === lower) input.checked = true;
        input.addEventListener('change', function(){ blockForm.time = lower; });
        wrap.appendChild(input);
        wrap.appendChild(document.createTextNode(' ' + label));
        blockTimes.appendChild(wrap);
      });
    }

    async function loadBlockAvailability(){
      if (!blockForm.employeeId){ blockAvailability = { dates: [], byDate: {} }; return; }
      setBlockLoading(true);
      try{
        const resp = await request('GET', '/books/availability?employee_id=' + encodeURIComponent(blockForm.employeeId));
        blockAvailability = normalizeAvailability(resp);
        if (blockAvailability.dates.length){ const ym = blockAvailability.dates[0].split('-'); blockMonth = new Date(Number(ym[0]), Number(ym[1])-1, 1); }
        // Reset selected date/time if no longer valid
        if (blockForm.date && blockAvailability.dates.indexOf(blockForm.date) === -1){ blockForm.date = ''; blockDateInput.value = ''; }
        blockForm.time = '';
        // Show date/time rows now that we have data
        const dateRow = document.getElementById('block_date_row'); if (dateRow) dateRow.style.display = '';
        const timeRow = document.getElementById('block_time_row'); if (timeRow) timeRow.style.display = '';
        renderBlockTimeSlots();
      } catch(e){
        console.error('Block availability failed', e);
        blockAvailability = { dates: [], byDate: {} };
        const dateRow = document.getElementById('block_date_row'); if (dateRow) dateRow.style.display = '';
        const timeRow = document.getElementById('block_time_row'); if (timeRow) timeRow.style.display = '';
        renderBlockTimeSlots();
      } finally {
        setBlockLoading(false);
      }
    }

    // Block modal open/close helpers
    function resetBlockFormUI(){
      if (blockEmpSelect) blockEmpSelect.value = '';
      if (blockDateInput) blockDateInput.value = '';
      if (blockTimes) { blockTimes.innerHTML = ''; }
      const dateRow = document.getElementById('block_date_row'); if (dateRow) dateRow.style.display = 'none';
      const timeRow = document.getElementById('block_time_row'); if (timeRow) timeRow.style.display = 'none';
      blockAvailability = { dates: [], byDate: {} };
      const h = document.getElementById('block_helper'); if (h) h.style.display = 'none';
      blockForm = { employeeId: '', date: '', time: '' };
    }
    function openBlockModal(){
      if (!blockModal) return;
      try{ updateBlockEmployeeSelect(); }catch(_){}
      resetBlockFormUI();
      blockModal.style.display = 'flex';
      // next frame to allow transition
      requestAnimationFrame(()=>{ blockModal.classList.add('modal-open'); });
      try { document.body.dataset.prevOverflow = document.body.style.overflow || ''; document.body.style.overflow = 'hidden'; } catch(_){}
      document.addEventListener('keydown', onBlockModalEsc);
    }
    function closeBlockModal(){
      if (!blockModal) return;
      closeBlockCal();
      blockModal.classList.remove('modal-open');
      const onEnd = () => {
        blockModal.style.display = 'none';
        try { document.body.style.overflow = document.body.dataset.prevOverflow || ''; delete document.body.dataset.prevOverflow; } catch(_){}
        document.removeEventListener('keydown', onBlockModalEsc);
      };
      blockModal.addEventListener('transitionend', onEnd, { once: true });
    }
    function onBlockModalEsc(e){ if (e.key === 'Escape') closeBlockModal(); }

    function renderCalendar(container, monthDate, onSelect, mode){
      const year = monthDate.getFullYear(); const month = monthDate.getMonth();
      const first = new Date(year, month, 1); const startDay = first.getDay();
      const dim = new Date(year, month+1, 0).getDate();
      let html = '';
      html += '<div class="inline" style="justify-content:space-between;align-items:center;margin-bottom:8px">'+
        '<button type="button" class="btn" data-cal="prev">&lt;</button>'+
        '<div style="font-weight:700">'+ monthDate.toLocaleString('en-US',{month:'long',year:'numeric'}) +'</div>'+
        '<button type="button" class="btn" data-cal="next">&gt;</button>'+
      '</div>';
      html += '<div class="inline" style="justify-content:space-between;font-weight:600">'+ ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=>'<div style="width:36px;text-align:center">'+d+'</div>').join('') +'</div>';
      html += '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:6px">';
      for (let i=0;i<startDay;i++) html += '<div></div>';
      for (let d=1; d<=dim; d++){
        const ymd = toYmd(new Date(year, month, d));
        let disabled = false;
        if (mode==='start' && dateFilter.endDate) {
          // disable dates after To Date
          disabled = compareYmd(ymd, dateFilter.endDate)===1;
        }
        if (mode==='end' && dateFilter.startDate) {
          // disable dates before From Date
          disabled = compareYmd(ymd, dateFilter.startDate)===-1;
        }
        // range highlight
        const inRange = compareYmd(ymd, dateFilter.startDate) >= 0 && compareYmd(ymd, dateFilter.endDate) <= 0;
        const isStart = ymd === dateFilter.startDate;
        const isEnd = ymd === dateFilter.endDate;
        const bg = inRange ? '#f6efe9' : '#fff';
        const radius = isStart ? '6px 0 0 6px' : (isEnd ? '0 6px 6px 0' : '6px');
        html += '<button type="button" class="cal-day" data-day="'+ymd+'" '+(disabled?'disabled':'')+' style="padding:6px 0;border:1px solid #eee;border-radius:'+radius+';background:'+bg+'">'+d+'</button>';
      }
      html += '</div>';
      container.innerHTML = html;
      const prev = container.querySelector('[data-cal="prev"]');
      const next = container.querySelector('[data-cal="next"]');
      prev.addEventListener('click', ()=> { monthDate.setMonth(monthDate.getMonth()-1); renderCalendar(container, monthDate, onSelect, mode); });
      next.addEventListener('click', ()=> { monthDate.setMonth(monthDate.getMonth()+1); renderCalendar(container, monthDate, onSelect, mode); });
      container.querySelectorAll('.cal-day').forEach(btn=> btn.addEventListener('click', ()=> onSelect(btn.getAttribute('data-day'))));
    }

    function inRange(ymd, start, end){ return compareYmd(ymd, start) >= 0 && compareYmd(ymd, end) <= 0; }

    function toYmdSafe(val){
      if (typeof val === 'number' && isFinite(val)) return toYmd(new Date(val * 1000));
      if (typeof val === 'string') {
        // try parse numeric string seconds
        const asNum = Number(val);
        if (isFinite(asNum)) return toYmd(new Date(asNum * 1000));
        // assume already ymd
        return val;
      }
      return '';
    }
    function mapApiBooking(item){
      // Expecting server fields; adapt as needed
      // Example assumes snake_case fields
      const statusMap = { PENDING:'pending', ACCEPTED:'confirmed', REJECTED:'cancelled', FINISHED:'completed', pending:'pending', accepted:'confirmed', rejected:'cancelled', finished:'completed' };
      // Derive service type: prefer item.service_type; fallback to nested employee.position/role
      let svc = 'photographer';
      const svcRaw = item.service_type || (item.employee && (item.employee.position || item.employee.role));
      if (typeof svcRaw === 'string'){
        const s = svcRaw.toUpperCase();
        if (s.includes('VIDEO')) svc = 'videographer';
        else if (s.includes('PHOTO')) svc = 'photographer';
      }
      return {
        id: String(item.id ?? ''),
        serviceType: svc,
        employeeId: String(item.employee_id ?? (item.employee && item.employee.id) ?? ''),
        employeeName: (item.employee && item.employee.name) || '',
        date: item.date_ymd || toYmdSafe(item.date) || '',
        time: (item.time_slot === 'AFTERNOON' ? 'afternoon' : (item.time_slot === 'FULL_DAY' ? 'fullday' : 'morning')),
        customerName: item.customer_name || '',
        phone: item.customer_phone || '',
        email: item.customer_email || '',
        status: statusMap[item.status] || 'pending',
        createdAt: item.created_at || ''
      };
    }

    function getEmployeeName(empId){
      if (!empId) return '-';
      const m = employeesMap[empId];
      return m || '-';
    }
    function slotLowerToUpper(s){ if (s==='morning') return 'MORNING'; if (s==='afternoon') return 'AFTERNOON'; return 'FULL_DAY'; }
    function statusIconSvg(status){
      // Simple inline SVGs, sized via CSS (.badge svg)
      const circle = '<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10" /></svg>';
      const check = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 16.2l-3.5-3.5L4 14.2l5 5 11-11-1.5-1.5z"/></svg>';
      const xmark = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18.3 5.71L12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.29 19.71 2.88 18.3 9.17 12 2.88 5.71 4.29 4.29 10.59 10.6l6.3-6.3z"/></svg>';
      const alert = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M1 21h22L12 2 1 21zm12-3h-2v2h2v-2zm0-8h-2v6h2V10z"/></svg>';
      if (status==='pending') return alert;
      if (status==='confirmed') return check;
      if (status==='completed') return circle;
      if (status==='cancelled') return xmark;
      return circle;
    }
    function getStatusMeta(status){
      const map = {
        pending: { cls:'badge badge-pending', svg: statusIconSvg('pending'), label:'Pending' },
        confirmed: { cls:'badge badge-confirmed', svg: statusIconSvg('confirmed'), label:'Confirmed' },
        completed: { cls:'badge badge-completed', svg: statusIconSvg('completed'), label:'Completed' },
        cancelled: { cls:'badge badge-cancelled', svg: statusIconSvg('cancelled'), label:'Cancelled' },
      };
      return map[status] || { cls:'badge badge-default', svg: statusIconSvg('unknown'), label: status };
    }
    function getTimeLabel(time){
      if (time==='morning') return 'Morning (08:00 - 12:00)';
      if (time==='afternoon') return 'Afternoon (13:00 - 17:00)';
      return 'Full Day (08:00 - 17:00)';
    }
    function formatDate(ymd){
      try {
        const d = parseYmd(ymd);
        return d.toLocaleDateString('en-US',{ day:'numeric', month:'long', year:'numeric' });
      } catch { return ymd; }
    }

    function renderTable(){
      const rows = getFiltered();
      const totalPages = Math.max(1, Math.ceil(rows.length / perPage));
      if (currentPage > totalPages) currentPage = totalPages;
      const startIdx = (currentPage - 1) * perPage;
      const slice = rows.slice(startIdx, startIdx + perPage);
      cardsEl.innerHTML = '';
      // Empty states
      if (bookings.length === 0){ emptyState.style.display=''; emptyState.textContent = 'No booking requests yet. Customer bookings will appear here.'; pagination.innerHTML=''; return; }
      if (rows.length === 0){ emptyState.style.display=''; emptyState.textContent = 'No results found. Try adjusting your date filters.'; pagination.innerHTML=''; return; }
      emptyState.style.display='none';
      slice.forEach(b => {
        const card = document.createElement('div'); card.className = 'admin-card';
        const meta = getStatusMeta(b.status);
        const empName = (b.employeeName && b.employeeName.trim()) ? b.employeeName : getEmployeeName(b.employeeId);
        const icon = b.serviceType === 'videographer' ? '🎬' : '📷';
        const busy = !!processing[b.id];
        card.innerHTML = 
          '<div class="admin-card-header">'
          +  '<div class="service-chip">' + (b.serviceType === 'videographer' ? '🎥' : '📷') + ' <span>'+b.customerName+'</span></div>'
          +  '<span class="'+meta.cls+'">'+meta.svg+' '+meta.label+'</span>'
          +'</div>'
          +'<div class="helper" style="margin-bottom:8px;">'+ b.serviceType + ' - ' + empName + '</div>'
          +'<div class="info-grid">'
          +  '<div><strong>Date</strong><div>'+formatDate(b.date)+'</div></div>'
          +  '<div><strong>Time</strong><div>'+getTimeLabel(b.time)+'</div></div>'
          +  '<div><strong>Phone</strong><div>'+ (b.phone || '-') +'</div></div>'
          +  '<div><strong>Email</strong><div>'+ (b.email || '-') +'</div></div>'
          +'</div>'
          +'<div class="card-actions">'+renderActionsHtml(b)+'</div>';
        cardsEl.appendChild(card);
        bindActionButtons(card, b);
      });
      renderPagination(totalPages);
    }

    function renderActionsHtml(b){
      const busy = !!processing[b.id];
      function btn(label, action, variant){ const cls = variant?(' btn-'+variant):''; return '<button class="btn'+cls+'" aria-label="'+label+'" data-action="'+action+'" '+(busy?'disabled':'')+' style="margin-right:6px;">'+(busy?'Processing...':label)+'</button>'; }
      if (b.status==='pending') return btn('Accept','confirm','') + btn('Reject','cancel','delete-ghost');
      if (b.status==='confirmed') return btn('Finish','complete','');
      return '';
    }
    function bindActionButtons(rootEl, b){
      const map = { confirm:'ACCEPTED', cancel:'REJECTED', complete:'FINISHED' };
      rootEl.querySelectorAll('button[data-action]').forEach(btn=>{
        btn.addEventListener('click', async function(){
          const act = btn.getAttribute('data-action');
          const target = map[act]; if (!target) return;
          // Validate transitions
          const valid = (b.status==='pending' && (target==='ACCEPTED' || target==='REJECTED')) || (b.status==='confirmed' && target==='FINISHED');
          if (!valid) { notify('Invalid transition for this booking','error'); return; }
          try {
            processing[b.id] = true; renderTable();
            await request('PUT', '/books/'+encodeURIComponent(b.id), { status: target });
            // reflect locally
            if (target==='ACCEPTED') b.status='confirmed';
            if (target==='REJECTED') b.status='cancelled';
            if (target==='FINISHED') b.status='completed';
            notify('Status updated','ok');
          } catch(e){
            console.error(e); notify('Failed to update status','error');
          } finally {
            delete processing[b.id]; renderTable();
          }
        });
      });
    }

    function renderPagination(totalPages){
      let html = '';
      // Halaman X dari Y label
      html += '<div class="helper" style="margin-bottom:8px;">Halaman '+currentPage+' dari '+totalPages+'</div>';
      if (totalPages <= 1){ pagination.innerHTML = html; return; }
      html += '<button class="btn" data-page="prev" '+(currentPage===1?'disabled':'')+'>Prev</button>';
      for (let p=1;p<=totalPages;p++){
        html += '<button class="btn" data-page="'+p+'" '+(p===currentPage?'style="background:var(--brand-primary);color:#fff;"':'')+'>'+p+'</button>';
      }
      html += '<button class="btn" data-page="next" '+(currentPage===totalPages?'disabled':'')+'>Next</button>';
      pagination.innerHTML = html;
    pagination.querySelectorAll('button[data-page]').forEach(btn=>{
      btn.addEventListener('click', function(){
        const val = btn.getAttribute('data-page');
        const total = totalPages;
        if (val==='prev' && currentPage>1) currentPage--;
        else if (val==='next' && currentPage<total) currentPage++;
        else if (!isNaN(Number(val))) currentPage = Number(val);
        if (serverMeta) { loadList(); } else { renderTable(); }
      });
    });
    }

    function getFiltered(){
      return bookings.filter(b => inRange(b.date, dateFilter.startDate, dateFilter.endDate));
    }

    // Load list
    async function tryEndpoints(paths){
      let lastErr;
      for (const p of paths){
        try { return await request('GET', p); } catch(e){ lastErr = e; }
      }
      throw lastErr || new Error('All endpoints failed');
    }

    async function loadList(){
      loadingList = true; loadingEl.style.display=''; loadBtn.disabled = true;
      try{
        const startSec = ymdToUtcSeconds(dateFilter.startDate);
        const endSec = ymdToUtcSeconds(dateFilter.endDate) + 86399; // inclusive end-of-day
        const path = '/books?date_from='+startSec+'&date_to='+endSec+'&page='+currentPage;
        const resp = await request('GET', path);
        const arr = Array.isArray(resp && resp.data) ? resp.data : (Array.isArray(resp) ? resp : []);
        bookings = arr.map(mapApiBooking);
        serverMeta = resp && resp.meta ? resp.meta : null;
        if (serverMeta && serverMeta.per_page) perPage = serverMeta.per_page;
        renderTable();
        notify('Loaded booking requests','ok');
      } catch(e){
        console.error(e);
        notify('Failed to load booking requests','error');
        // Mock fallback
        if (window.BOOKING_USE_MOCKS){
          bookings = [
            { id:'bk_001', serviceType:'photographer', employeeId:'1', date: toYmd(new Date()), time:'morning', customerName:'Jane', phone:'08123', email:'jane@example.com', status:'pending', createdAt: new Date().toISOString() },
            { id:'bk_002', serviceType:'videographer', employeeId:'2', date: toYmd(new Date()), time:'afternoon', customerName:'Bob', phone:'08124', email:'bob@example.com', status:'confirmed', createdAt: new Date().toISOString() },
          ];
          serverMeta = null; currentPage = 1; renderTable();
        } else {
          serverMeta = null; bookings = []; renderTable();
        }
      } finally {
        loadingList = false; loadingEl.style.display='none'; loadBtn.disabled = false;
      }
    }

    async function loadEmployeesMap(){
      try {
        const resp = await request('GET', '/employees?page=1&per_page=1000');
        const arr = Array.isArray(resp && resp.data) ? resp.data : [];
        const mapPos = function (pos) {
          const p = (pos || '').toUpperCase();
          if (p.indexOf('PHOTOGRAPHER') !== -1) return 'photographer';
          if (p.indexOf('VIDEOGRAPHER') !== -1) return 'videographer';
          return undefined;
        };
        employeesMap = {};
        arr.forEach(function(e){ employeesMap[String(e.id)] = e.name || ('Employee '+e.id); });
      } catch(e){
        console.warn('Failed to load employees map', e);
        employeesMap = {};
      }
      // Populate block employee select when data is available
      try { updateBlockEmployeeSelect(); } catch(_){ }
    }

    function updateBlockEmployeeSelect(){
      if (!blockEmpSelect) return;
      const entries = Object.entries(employeesMap);
      const has = entries.length > 0;
      blockEmpSelect.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.disabled = true; opt0.selected = true;
      opt0.textContent = has ? 'Select employee' : 'No employees available';
      blockEmpSelect.appendChild(opt0);
      entries.forEach(([id, name]) => {
        const opt = document.createElement('option');
        opt.value = String(id); opt.textContent = name || ('Employee '+id);
        blockEmpSelect.appendChild(opt);
      });
    }

    // Wire events
    startInput.addEventListener('click', ()=>{ openCal('start'); });
    endInput.addEventListener('click', ()=>{ openCal('end'); });
    loadBtn.addEventListener('click', ()=>{ currentPage = 1; serverMeta = null; loadList(); });

    // Wire block UI
    if (openBlockBtn) openBlockBtn.addEventListener('click', openBlockModal);
    if (blockCloseBtn) blockCloseBtn.addEventListener('click', closeBlockModal);
    if (blockModal) blockModal.addEventListener('click', function(e){ if (e.target === blockModal) closeBlockModal(); });
    if (blockDateInput) blockDateInput.addEventListener('click', function(){ if (blockForm.employeeId) openBlockCal(); });
    if (blockEmpSelect) blockEmpSelect.addEventListener('change', function(){ blockForm.employeeId = blockEmpSelect.value; blockForm.date=''; if (blockDateInput) blockDateInput.value=''; blockForm.time=''; loadBlockAvailability(); });
    if (blockBtn) blockBtn.addEventListener('click', async function(){
      if (!blockForm.employeeId) { notify('Select an employee first','error'); return; }
      if (!blockForm.date) { notify('Pick a date to block','error'); return; }
      if (!blockForm.time) { notify('Select a time slot','error'); return; }
      const payload = { employee_id: blockForm.employeeId, date: ymdToUtcSeconds(blockForm.date), time_slot: slotLowerToUpper(blockForm.time) };
      try {
        await request('POST', '/books/admin-off', payload);
        notify('Availability blocked','ok');
        closeBlockModal();
        // Optionally refresh list
        try { loadList(); } catch(_){}
      } catch(e){
        console.error(e);
        notify('Failed to block availability','error');
      }
    });

    // Init
    renderFilters();
    // Auto-load bookings for current month range on first open
    loadList();
    loadEmployeesMap();
  </script>
</body>

</html>
<!-- -->
